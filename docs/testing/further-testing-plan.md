# План дальнейших работ по тестированию и улучшению

> **Дата создания:** 2025-11-29  
> **Статус:** В работе

## Резюме

План содержит задачи для завершения тестирования функционала AI-обработки дат и команды `/todo`, а также улучшения качества кода и тестов.

## Что делать дальше

### 1. Исправить импорты в test_ai_date_parsing.py

**Проблема:** Ошибка импорта при попытке запустить тесты AI-обработки
- Ошибка: `ImportError: attempted relative import beyond top-level package` в `agents/orchestrator.py:9`
- Причина: Структура импортов в модулях агентов использует относительные импорты, которые не работают при запуске тестов из корня проекта

**Решение:**
- Вариант 1: Изменить относительные импорты в модулях агентов на абсолютные
- Вариант 2: Настроить PYTHONPATH или pytest для корректной работы с относительными импортами
- Вариант 3: Использовать моки для всех зависимостей перед импортом модулей

**Файлы для изменения:**
- `task_tracker_bot/tests/test_ai_date_parsing.py`
- `task_tracker_bot/agents/orchestrator.py` (если выбран вариант 1)
- `task_tracker_bot/agents/__init__.py` (если выбран вариант 1)

**Приоритет:** Высокий

---

### 2. Проверить ответы бота

**Проблема:** Команды отправлены через Telegram MCP, но ответы от бота не получены
- Команда `/todo` отправлена в 12:25:55 UTC
- AI-запрос "Добавь на завтра задачи: купить молоко, позвонить маме" отправлен в 12:26:14 UTC
- Ответы не получены в течение тестового периода

**Действия:**
1. Проверить логи бота на наличие ошибок обработки команд
2. Увеличить время ожидания ответа от бота
3. Проверить регистрацию обработчиков команд в `bot.py`
4. Проверить работу обработчиков напрямую через Telegram
5. Добавить логирование в обработчики для отладки

**Файлы для проверки:**
- `bot.log` - логи бота
- `task_tracker_bot/bot.py` - регистрация обработчиков
- `task_tracker_bot/handlers/todo_handler.py` - обработчик команды /todo
- `task_tracker_bot/handlers/ai_handler.py` - обработчик AI-запросов

**Приоритет:** Высокий

---

### 3. Проверить БД вручную

**Задача:** Убедиться, что AI-запросы корректно создают задачи в базе данных

**SQL запросы для проверки:**
```sql
-- Проверить созданные задачи на завтра
SELECT * FROM personal_tasks 
WHERE user_id = 164692303 
AND scheduled_date = DATE('now', '+1 day')
ORDER BY id DESC LIMIT 10;

-- Проверить все недавно созданные задачи
SELECT * FROM personal_tasks 
WHERE user_id = 164692303 
ORDER BY id DESC LIMIT 20;

-- Проверить задачи с датами
SELECT id, title, scheduled_date, scheduled_time, completed 
FROM personal_tasks 
WHERE user_id = 164692303 
AND scheduled_date IS NOT NULL
ORDER BY scheduled_date DESC, id DESC;
```

**Действия:**
1. Выполнить SQL запросы для проверки создания задач
2. Проверить корректность дат и времени
3. Проверить названия задач
4. Убедиться, что задачи созданы с правильным user_id

**Файлы для проверки:**
- `data/tasks.db` - база данных

**Приоритет:** Средний

---

## Предложения по улучшению

### 1. Добавить таймауты и повторные попытки при тестировании через Telegram MCP

**Проблема:** При тестировании через Telegram MCP ответы от бота могут приходить с задержкой

**Решение:**
- Добавить функцию ожидания ответа от бота с таймаутом
- Реализовать повторные попытки получения сообщений
- Добавить проверку наличия новых сообщений перед завершением теста

**Пример реализации:**
```python
async def wait_for_bot_response(chat_id, timeout=30, max_attempts=3):
    """Ожидание ответа от бота с таймаутом и повторными попытками"""
    for attempt in range(max_attempts):
        await asyncio.sleep(timeout / max_attempts)
        messages = get_messages(chat_id, page=1, page_size=1)
        if messages and messages[0].from_user.type == 'bot':
            return messages[0]
    return None
```

**Приоритет:** Средний

---

### 2. Улучшить логирование — добавить более детальные логи для отладки обработки команд

**Проблема:** Текущие логи не содержат достаточно информации для отладки обработки команд

**Решение:**
- Добавить логирование в начало каждого обработчика команды
- Логировать параметры запроса (user_id, текст команды, аргументы)
- Логировать результаты обработки (успех/ошибка, созданные задачи)
- Добавить логирование времени выполнения обработки

**Файлы для изменения:**
- `task_tracker_bot/handlers/todo_handler.py`
- `task_tracker_bot/handlers/ai_handler.py`
- `task_tracker_bot/agents/agent_coordinator.py`

**Пример:**
```python
logger.info(f"Обработка команды /todo для user_id={user_id}, args={args}")
logger.debug(f"Парсинг даты: '{date_text}' → {parsed_date}")
logger.info(f"Создано задач: {len(tasks)}, время выполнения: {elapsed_time}s")
```

**Приоритет:** Средний

---

### 3. Исправить структуру импортов в модулях агентов для корректной работы тестов

**Проблема:** Относительные импорты в модулях агентов вызывают ошибки при запуске тестов

**Решение:**
- Изменить относительные импорты на абсолютные в модулях агентов
- Или настроить pytest для корректной работы с относительными импортами
- Или использовать другой подход к тестированию (интеграционные тесты вместо unit-тестов)

**Файлы для изменения:**
- `task_tracker_bot/agents/orchestrator.py` - изменить `from ..config import Config` на `from config import Config`
- `task_tracker_bot/agents/__init__.py` - проверить импорты
- Другие модули агентов с относительными импортами

**Приоритет:** Низкий (можно отложить, если тесты не критичны)

---

## Потенциальные недоработки

### 1. Импорты в test_ai_date_parsing.py требуют более глубокого исправления структуры проекта

**Описание:** Проблема с импортами может указывать на более глубокие проблемы в структуре проекта

**Рекомендации:**
- Провести аудит структуры импортов во всем проекте
- Унифицировать подход к импортам (все абсолютные или все относительные)
- Документировать правила импортов для разработчиков

**Приоритет:** Низкий

---

### 2. Ответы от бота не получены в течение тестового периода — возможно, требуется больше времени для AI-обработки или есть проблемы с обработчиками

**Описание:** Команды отправлены, но ответы не получены

**Возможные причины:**
1. AI-обработка занимает много времени (таймаут)
2. Ошибки в обработчиках команд
3. Проблемы с базой данных
4. Проблемы с регистрацией обработчиков

**Действия:**
1. Проверить логи на наличие ошибок
2. Увеличить таймауты для AI-обработки
3. Добавить обработку ошибок в обработчики
4. Проверить работу обработчиков напрямую

**Приоритет:** Высокий

---

## Чеклист выполнения

- [ ] Исправлены импорты в test_ai_date_parsing.py
- [ ] Проверены ответы бота и исправлены проблемы
- [ ] Выполнены SQL запросы для проверки БД
- [ ] Добавлены таймауты и повторные попытки при тестировании
- [ ] Улучшено логирование обработки команд
- [ ] Исправлена структура импортов в модулях агентов
- [ ] Проведен аудит структуры импортов проекта
- [ ] Решены проблемы с получением ответов от бота

---

## Связанные файлы

- `docs/testing/ai-date-parsing-test-report.md` - отчет о тестировании
- `task_tracker_bot/tests/test_ai_date_parsing.py` - тесты AI-обработки
- `task_tracker_bot/handlers/todo_handler.py` - обработчик команды /todo
- `task_tracker_bot/handlers/ai_handler.py` - обработчик AI-запросов
- `task_tracker_bot/agents/orchestrator.py` - модуль оркестратора
- `bot.log` - логи бота
- `data/tasks.db` - база данных

---

## Примечания

- Все задачи должны быть выполнены с тестированием через Telegram MCP
- После каждого исправления необходимо проверить работу через Telegram
- Результаты тестирования должны быть зафиксированы в отчете

