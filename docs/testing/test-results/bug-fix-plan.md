# План исправления багов MVP 0.2

> **Дата создания:** 2025-11-29  
> **Основан на:** mvp-0.2-manual-test-results.md

## Приоритеты исправлений

1. **Критический:** БАГ #2 - блокирует создание зависимостей типа move_task
2. **Высокий:** БАГ #3 - неправильные названия задач
3. **Высокий:** БАГ #1 - проблемы с парсингом команд

---

## БАГ #2: Неправильный парсинг команды /newdependency с кавычками

### Описание проблемы
Команда `/newdependency` не может правильно обработать названия досок/колонок с пробелами, даже если они в кавычках. Парсер аргументов команды неправильно обрабатывает кавычки, из-за чего `action_type` получает неправильное значение.

### Ожидаемое поведение
Команда должна правильно парсить аргументы, учитывая кавычки в названиях досок и колонок.

### План исправления

1. **Анализ текущей реализации**
   - Файл: `task_tracker_bot/handlers/dependency.py`
   - Функция: `newdependency_command`
   - Проблема: Используется простой `context.args`, который не учитывает кавычки

2. **Решение**
   - Создать функцию для правильного парсинга аргументов с учетом кавычек
   - Или использовать более умный парсер, который объединяет аргументы в кавычках
   - Альтернатива: Изменить формат команды, чтобы избежать проблем с пробелами

3. **Реализация**
   - Создать утилиту `parse_quoted_args` в `task_tracker_bot/utils/validators.py` или новом файле
   - Обновить `newdependency_command` для использования нового парсера
   - Протестировать с различными комбинациями кавычек и пробелов

4. **Файлы для изменения**
   - `task_tracker_bot/handlers/dependency.py` - обновить парсинг
   - `task_tracker_bot/utils/validators.py` или новый файл - добавить функцию парсинга

5. **Тесты для проверки**
   - `/newdependency "Тестирование->Разработка Фикс" Тестирование Реджект Разработка "Фикс Багов" move_task`
   - `/newdependency "Разработка->Подготовка аккаунта" Разработка Тестирование "Подготовка аккаунта" Очередь create_task "{project_id} {project_name} Подготовить аккаунт"`

---

## БАГ #3: Неправильное название задачи при создании через зависимость

### Описание проблемы
При создании задачи через зависимость в название попадают кавычки из шаблона, и название обрезается.

### Ожидаемое поведение
Название задачи должно формироваться из шаблона без кавычек, с правильной подстановкой переменных `{project_id}` и `{project_name}`.

### План исправления

1. **Анализ текущей реализации**
   - Файл: `task_tracker_bot/services/dependency_service.py`
   - Проблема: Шаблон задачи содержит кавычки, которые попадают в название

2. **Решение**
   - Убрать кавычки из шаблона при сохранении зависимости
   - Или убрать кавычки при обработке шаблона перед созданием задачи
   - Проверить логику подстановки переменных в шаблон

3. **Реализация**
   - Найти место, где шаблон используется для создания задачи
   - Убрать кавычки из шаблона перед использованием
   - Проверить, что переменные правильно подставляются
   - Проверить ограничение длины названия задачи

4. **Файлы для изменения**
   - `task_tracker_bot/services/dependency_service.py` - обработка шаблона
   - Возможно `task_tracker_bot/repositories/board_dependency_repository.py` - сохранение шаблона

5. **Тесты для проверки**
   - Создать зависимость с шаблоном `"{project_id} {project_name} Дизайн"`
   - Переместить задачу в триггерную колонку
   - Проверить, что созданная задача имеет название "5001 Pictory Ai Дизайн" (без кавычек)

---

## БАГ #1: Неправильный парсинг названия доски с пробелами в команде /addcolumn

### Описание проблемы
При добавлении колонки к доске с названием, содержащим пробелы, команда парсится неправильно.

### Ожидаемое поведение
Команда должна правильно определять название доски и название колонки, даже если доска содержит пробелы.

### План исправления

1. **Анализ текущей реализации**
   - Файл: `task_tracker_bot/handlers/board.py`
   - Функция: `addcolumn_command`
   - Проблема: Команда использует простой парсинг `args[0]` и `args[1]`, что не работает для досок с пробелами

2. **Решение**
   - Использовать более умный парсинг, который учитывает, что последний аргумент - это название колонки
   - Или изменить формат команды: `/addcolumn "<название доски>" "<название колонки>"`
   - Или использовать поиск доски по частичному совпадению

3. **Реализация**
   - Обновить `addcolumn_command` для правильного парсинга
   - Использовать подход: все аргументы кроме последнего - название доски, последний - название колонки
   - Или использовать функцию парсинга с кавычками (как для БАГ #2)

4. **Файлы для изменения**
   - `task_tracker_bot/handlers/board.py` - функция `addcolumn_command`

5. **Тесты для проверки**
   - `/addcolumn Подготовка аккаунта План на неделю` - должна добавить колонку "План на неделю" в доску "Подготовка аккаунта"

---

## Порядок выполнения исправлений

1. **Шаг 1:** Исправить БАГ #2 (критический)
   - Создать функцию парсинга аргументов с кавычками
   - Обновить `newdependency_command`
   - Протестировать

2. **Шаг 2:** Исправить БАГ #3 (высокий)
   - Найти и исправить обработку шаблона задачи
   - Протестировать создание задач через зависимости

3. **Шаг 3:** Исправить БАГ #1 (высокий)
   - Обновить парсинг в `addcolumn_command`
   - Протестировать добавление колонок к доскам с пробелами

4. **Шаг 4:** Повторное тестирование
   - Выполнить все тесты из руководства
   - Проверить, что все баги исправлены
   - Убедиться, что не появились новые баги

---

## Дополнительные улучшения

После исправления основных багов рекомендуется:

1. Добавить валидацию входных данных для всех команд
2. Улучшить обработку ошибок с более понятными сообщениями
3. Добавить unit-тесты для парсинга команд
4. Документировать формат команд с примерами использования кавычек

