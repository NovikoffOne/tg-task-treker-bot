# Тест кейсы для проверки работы AI сети

> **Дата создания:** 2025-01-28  
> **Версия:** 1.0

Этот документ содержит тест кейсы для ручного тестирования улучшений AI сети.

## Подготовка к тестированию

1. Убедитесь, что бот запущен и работает
2. Убедитесь, что установлены переменные окружения:
   - `IO_NET_API_KEY` - API ключ io.net
   - `BOT_TOKEN` - токен Telegram бота
3. Убедитесь, что у вас есть хотя бы одно workspace в системе

## Тест кейсы

### 1. Создание проекта через AI

**Цель:** Проверить создание проекта через естественный запрос и сохранение workspace в user_data

**Шаги:**
1. Отправьте боту команду `/ai` для активации AI-режима
2. Отправьте запрос: `Создай проект id+ Test Project`
3. Проверьте ответ бота
4. Отправьте еще один запрос: `Покажи проект Test Project`
5. Проверьте, что workspace сохранился (второй запрос должен использовать тот же workspace)

**Ожидаемый результат:**
- ✅ Проект создан успешно
- ✅ Workspace сохранен в user_data
- ✅ Второй запрос использует тот же workspace без запроса к БД
- ✅ В логах видно время выполнения операции

**Проверка логов:**
```bash
grep "Workspace.*сохранен в user_data" bot.log
grep "Обработка сообщения завершена за" bot.log
```

---

### 2. Добавление ссылки к проекту

**Цель:** Проверить добавление ссылки через AI

**Шаги:**
1. Отправьте запрос: `Добавь ТЗ https://example.com к проекту 5005`
2. Проверьте ответ бота
3. Проверьте, что ссылка действительно добавлена к проекту

**Ожидаемый результат:**
- ✅ Ссылка добавлена успешно
- ✅ В логах видно метрики времени выполнения каждого шага
- ✅ Нет ошибок в логах

**Проверка логов:**
```bash
grep "Шаг.*выполнен за" bot.log
grep "execution_time_ms" bot.log
```

---

### 3. Проверка retry при ошибке API

**Цель:** Проверить работу retry логики при временных ошибках API

**Шаги:**
1. Временно установите неверный API ключ или симулируйте таймаут
2. Отправьте запрос: `Создай проект id+ Retry Test`
3. Проверьте логи на наличие попыток retry
4. Восстановите правильный API ключ
5. Повторите запрос

**Ожидаемый результат:**
- ✅ При ошибке видны попытки retry в логах
- ✅ Retry выполняется с экспоненциальной задержкой
- ✅ После восстановления API запрос выполняется успешно

**Проверка логов:**
```bash
grep "Повтор через" bot.log
grep "попытка.*retry" bot.log
grep "Таймаут при вызове io.net API" bot.log
```

---

### 4. Проверка кэширования Orchestrator

**Цель:** Проверить работу кэша для одинаковых запросов

**Шаги:**
1. Отправьте запрос: `Сколько задач в работе?`
2. Запомните время ответа
3. Сразу же отправьте тот же запрос еще раз
4. Сравните время ответа

**Ожидаемый результат:**
- ✅ Второй запрос выполняется быстрее (используется кэш)
- ✅ В логах видно "Кэш попадание"
- ✅ Результаты идентичны

**Проверка логов:**
```bash
grep "Кэш попадание" bot.log
grep "Кэш промах" bot.log
```

**Примечание:** Кэш действителен 5 минут (300 секунд) по умолчанию.

---

### 5. Проверка метрик времени выполнения

**Цель:** Проверить логирование метрик производительности

**Шаги:**
1. Отправьте любой запрос через AI
2. Проверьте логи на наличие метрик

**Ожидаемый результат:**
- ✅ В логах видно общее время выполнения запроса
- ✅ В логах видно время анализа запроса
- ✅ В логах видно время выполнения каждого шага
- ✅ Метрики включены в ответ API (в поле `metrics`)

**Проверка логов:**
```bash
grep "Обработка сообщения завершена за" bot.log
grep "Анализ запроса выполнен за" bot.log
grep "Шаг.*выполнен за" bot.log
```

**Пример логов:**
```
INFO: Обработка сообщения завершена за 1234.56ms (анализ: 234.12ms, шаги: 1000.44ms)
INFO: Шаг ADM.get_next_project_id выполнен за 456.78ms
```

---

### 6. Проверка обработки таймаутов

**Цель:** Проверить улучшенную обработку таймаутов

**Шаги:**
1. Установите очень маленький timeout в конфигурации (например, 1 секунда)
2. Отправьте сложный запрос, который может занять больше времени
3. Проверьте поведение системы

**Ожидаемый результат:**
- ✅ Система пытается повторить запрос при таймауте
- ✅ Понятное сообщение об ошибке пользователю
- ✅ В логах видно информацию о таймауте и retry

**Проверка логов:**
```bash
grep "Таймаут при вызове io.net API" bot.log
grep "Повтор через.*секунд" bot.log
```

---

### 7. Проверка множественных запросов

**Цель:** Проверить работу системы при множественных запросах

**Шаги:**
1. Отправьте несколько разных запросов подряд:
   - `Создай проект id+ Project 1`
   - `Создай проект id+ Project 2`
   - `Создай проект id+ Project 3`
2. Проверьте, что все запросы обработаны корректно
3. Проверьте метрики в логах

**Ожидаемый результат:**
- ✅ Все запросы обработаны успешно
- ✅ Workspace сохраняется между запросами
- ✅ Метрики логируются для каждого запроса
- ✅ Нет конфликтов или ошибок

---

### 8. Проверка нормализации запросов для кэша

**Цель:** Проверить, что кэш работает для запросов с разным форматированием

**Шаги:**
1. Отправьте запрос: `Создай проект id+ Test`
2. Отправьте запрос: `создай проект id+ test` (другой регистр)
3. Отправьте запрос: `Создай  проект   id+  Test` (лишние пробелы)
4. Проверьте логи

**Ожидаемый результат:**
- ✅ Все три запроса используют один и тот же кэш
- ✅ В логах видно "Кэш попадание" для второго и третьего запроса

---

## Проверка конфигурации

Убедитесь, что все параметры конфигурации установлены правильно:

```bash
# Проверка переменных окружения
echo $IO_NET_TIMEOUT          # Должно быть 60 (по умолчанию)
echo $IO_NET_RETRY_COUNT      # Должно быть 3 (по умолчанию)
echo $IO_NET_RETRY_DELAY      # Должно быть 1.0 (по умолчанию)
echo $ORCHESTRATOR_CACHE_TTL  # Должно быть 300 (5 минут, по умолчанию)
```

## Критерии успешного тестирования

Все тесты считаются успешными, если:

1. ✅ Все операции выполняются корректно
2. ✅ Workspace сохраняется в user_data
3. ✅ Retry логика работает при ошибках
4. ✅ Кэш работает для одинаковых запросов
5. ✅ Метрики времени логируются корректно
6. ✅ Нет критических ошибок в логах
7. ✅ Время выполнения операций разумное (< 10 секунд для простых запросов)

## Известные ограничения

1. Тесты retry требуют симуляции ошибок API (можно использовать моки)
2. Кэш очищается автоматически через TTL, но можно очистить вручную через `orchestrator.clear_cache()`
3. Метрики времени могут варьироваться в зависимости от нагрузки на API

## Отчет о тестировании

После выполнения всех тестов заполните отчет:

- [ ] Тест 1: Создание проекта - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 2: Добавление ссылки - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 3: Retry при ошибке - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 4: Кэширование - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 5: Метрики времени - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 6: Обработка таймаутов - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 7: Множественные запросы - ПРОЙДЕН / НЕ ПРОЙДЕН
- [ ] Тест 8: Нормализация для кэша - ПРОЙДЕН / НЕ ПРОЙДЕН

**Дата тестирования:** _______________  
**Тестировщик:** _______________  
**Версия бота:** _______________

